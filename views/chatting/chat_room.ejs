<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/css/gomaching.css">
    <link rel="stylesheet" href="/css/topcommon.css">
    <title>7-Talk</title>
</head>

<body>
    <div class="maching-page">
        <nav class='top_menu'>
            <ul>
                <li>
                    <a href="/user/main" class='notunder'>
                        <img id="myInfo" src="/images/004-user.png" alt="my_info_icon">
                    </a>
                </li>
                <li>
                    <a href="/chatting/chatroom" class='notunder'>
                        <img id="heart" src="/images/003-heart-1.png" alt="maching_icon">
                    </a>
                </li>
                <li>
                    <a href="/posting" class='notunder'>
                        <img id="post" src="/images/001-post-it.png" alt="post_icon">
                    </a>
                </li>
            </ul>
        </nav>

        <img id="chat" src="/images/chat.png" alt="chat_icon">
        <a href="javascript:goMatching();">
            <form class="maching-form">
                <img id="like" src="/images/like.png" alt="like_icon">
                <img id="arrow" src="/images/double-angle-pointing-to-right.png" alt="arrow_icon">
                <img id="like2" src="/images/like.png" alt="like2_icon">
            </form>
        </a>
        <form class "chatting-form">
            <ul id="chatlist">
                <li id="chatroom">
                    <a href="/chatting/chat/1">채팅방 1</a>
                </li>
                <li id="chatroom">
                    <a href="/chatting/chat/2">채팅방 2</a>
                </li>
                <li id="chatroom">
                    <a href="/chatting/chat/3">채팅방 3</a>
                </li>
            </ul>
        </form>
    </div>
    </div>
    <script>
        function goMatching(){
            if(sessionStorage.getItem('match_status')== 'true'){
                alert('이미 매칭 중입니다! 매칭이 완료되길 기다려주세요.');
            }else{
                location.href = '/matching';
            }
        }

        (function start(){
            var httpRequest;
            if (window.XMLHttpRequest) { // 모질라, 사파리등 그외 브라우저, ...
                httpRequest = new XMLHttpRequest();
            } else if (window.ActiveXObject) { // IE 8 이상
                httpRequest = new ActiveXObject("Microsoft.XMLHTTP");
            }
            httpRequest.onreadystatechange = function () {
                if (httpRequest.readyState == 4 && httpRequest.status == 200) {
                    var json = JSON.parse(httpRequest.responseText);
                    if( json.data.result.length != 0){
                        sessionStorage.setItem('match_status', 'false');
                        requestChatroom(json.data.result[0]);
                    }
                }
            };
            httpRequest.open('GET', location.origin + '/api/recommend/alert', true);
            httpRequest.send();
        })();

        function requestChatroom(opposite_email){
            var body = new Object();
            body.oppositeEmail = opposite_email;

            var httpRequest;
            if (window.XMLHttpRequest) { // 모질라, 사파리등 그외 브라우저, ...
                httpRequest = new XMLHttpRequest();
            } else if (window.ActiveXObject) { // IE 8 이상
                httpRequest = new ActiveXObject("Microsoft.XMLHTTP");
            }
            httpRequest.onreadystatechange = function () {
                if (httpRequest.readyState == 4 && httpRequest.status == 200) {
                    alert('매칭성공!');
                    console.log(httpRequest.responseText);
                }
            };
            httpRequest.open('POST', location.origin + '/api/matching', true);
            httpRequest.send(JSON.stringify(body));
        }
    </script>

</body>

</html>
